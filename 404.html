<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#000000"/>
<title>lotWalk</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- Utils ----------
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nowISO = () => new Date().toISOString();
    const LS_KEYS = {
      dealers: "pdr_dealerships",
      forms: "pdr_forms"
    };

    function useLocalStorage(key, initialValue) {
      const [value, setValue] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; } catch { return initialValue; }
      });
      useEffect(()=>{ try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }, [key, value]);
      return [value, setValue];
    }

    // ---------- Data migration ----------
    function migrate(dealers, forms) {
      // Ensure dealer has contacts array and primaryEmail
      dealers = (dealers||[]).map(d => ({
        id: d.id || uid(),
        name: d.name || "Unnamed",
        primaryEmail: d.primaryEmail || d.email || "",
        contacts: Array.isArray(d.contacts) ? d.contacts : [],
        archived: !!d.archived
      }));
      // Map old NotInv -> NoCharge; add new statuses support
      forms = (forms||[]).map(f => ({
        ...f,
        vehicles: (f.vehicles||[]).map(v => ({
          ...v,
          status: v.status === "NotInv" ? "NoCharge" : v.status,
          notComplete: !!v.notComplete
        }))
      }));
      return { dealers, forms };
    }

    // ---------- Components ----------
    function Nav({ route, setRoute }) {
      const Item = ({r,label}) => (
        <button onClick={()=>setRoute(r)} className={"px-3 py-2 rounded-xl border " + (route===r ? "bg-black text-white" : "bg-white")}>{label}</button>
      );
      return (
        <div className="sticky top-0 z-10 bg-gray-50/80 backdrop-blur border-b">
          <div className="mx-auto max-w-5xl p-3 flex items-center gap-2">
            <div className="text-lg font-semibold">lotWalk</div>
            <div className="flex gap-2 ml-4">
              <Item r="walks" label="Walks" />
              <Item r="dealers" label="Dealerships" />
              <Item r="settings" label="Settings" />
            </div>
            <div className="flex-1" />
          </div>
        </div>
      );
    }

    function DealerManagePage({ dealers, setDealers, forms }) {
      const [showArchived, setShowArchived] = useState(false);
      const filtered = dealers.filter(d => showArchived || !d.archived);

      const addDealer = () => {
        const name = prompt("Dealership name?");
        if (!name) return;
        const d = { id: uid(), name, primaryEmail:"", contacts:[], archived:false };
        setDealers([d, ...dealers]);
      };

      const updateDealer = (id, patch) => setDealers(dealers.map(d => d.id===id ? {...d, ...patch} : d));
      const toggleArchive = (id) => updateDealer(id, { archived: !dealers.find(d=>d.id===id).archived });
      const canDelete = (id) => !forms.some(f => f.dealershipId === id);
      const deleteDealer = (id) => {
        if (!canDelete(id)) return alert("Cannot delete: dealer has forms. Archive instead.");
        if (confirm("Delete this empty dealership?")) setDealers(dealers.filter(d => d.id !== id));
      };

      const mergeDealers = (fromId, toId) => {
        if (fromId === toId) return alert("Choose two different dealerships.");
        // Reassign forms
        const updatedForms = forms.map(f => f.dealershipId===fromId ? {...f, dealershipId: toId} : f);
        window._setForms(updatedForms);
        // Optionally archive the source
        updateDealer(fromId, { archived: true });
        alert("Merged: forms moved and source archived.");
      };

      const addContact = (dealerId) => {
        const name = prompt("Contact name?"); if (!name) return;
        const role = prompt("Role (e.g., Manager)?") || "";
        const email = prompt("Email?") || "";
        const phone = prompt("Phone?") || "";
        updateDealer(dealerId, {
          contacts: [...dealers.find(d=>d.id===dealerId).contacts, { id: uid(), name, role, email, phone }]
        });
      };
      const removeContact = (dealerId, contactId) => {
        const d = dealers.find(d=>d.id===dealerId);
        updateDealer(dealerId, { contacts: d.contacts.filter(c=>c.id!==contactId) });
      };

      const [mergeFrom, setMergeFrom] = useState("");
      const [mergeTo, setMergeTo] = useState("");

      return (
        <div className="mx-auto max-w-5xl p-4 space-y-4">
          <div className="flex items-center gap-2">
            <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={addDealer}>+ Dealer</button>
            <label className="ml-2 text-sm flex items-center gap-2">
              <input type="checkbox" className="w-4 h-4" checked={showArchived} onChange={e=>setShowArchived(e.target.checked)} />
              Show archived
            </label>
          </div>

          <div className="grid gap-3">
            {filtered.map(d => (
              <div key={d.id} className="border rounded-2xl p-3 bg-white">
                <div className="flex items-center gap-3">
                  <input className="px-3 py-2 border rounded-xl flex-1" value={d.name} onChange={e=>updateDealer(d.id,{name:e.target.value})} />
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>toggleArchive(d.id)}>{d.archived ? "Unarchive" : "Archive"}</button>
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>deleteDealer(d.id)} disabled={!canDelete(d.id)} title={canDelete(d.id)? "Delete" : "Has forms"}>Delete</button>
                </div>
                <div className="grid md:grid-cols-2 gap-3 mt-3">
                  <label className="text-sm">Primary email
                    <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={d.primaryEmail||""} onChange={e=>updateDealer(d.id,{primaryEmail:e.target.value})} />
                  </label>
                </div>
                <div className="mt-3">
                  <div className="flex items-center justify-between">
                    <p className="text-sm font-medium">Contacts</p>
                    <button className="px-3 py-1.5 rounded-xl border" onClick={()=>addContact(d.id)}>Add contact</button>
                  </div>
                  <ul className="mt-2 space-y-2">
                    {d.contacts.map(c => (
                      <li key={c.id} className="grid md:grid-cols-5 gap-2 items-center">
                        <input className="px-3 py-2 border rounded-xl" value={c.name} onChange={e=>updateDealer(d.id,{contacts: d.contacts.map(x=>x.id===c.id?{...x,name:e.target.value}:x)})} placeholder="Name"/>
                        <input className="px-3 py-2 border rounded-xl" value={c.role||""} onChange={e=>updateDealer(d.id,{contacts: d.contacts.map(x=>x.id===c.id?{...x,role:e.target.value}:x)})} placeholder="Role"/>
                        <input className="px-3 py-2 border rounded-xl" value={c.email||""} onChange={e=>updateDealer(d.id,{contacts: d.contacts.map(x=>x.id===c.id?{...x,email:e.target.value}:x)})} placeholder="Email"/>
                        <input className="px-3 py-2 border rounded-xl" value={c.phone||""} onChange={e=>updateDealer(d.id,{contacts: d.contacts.map(x=>x.id===c.id?{...x,phone:e.target.value}:x)})} placeholder="Phone"/>
                        <button className="px-3 py-2 rounded-xl border" onClick={()=>removeContact(d.id, c.id)}>Remove</button>
                      </li>
                    ))}
                    {d.contacts.length===0 && <li className="text-sm text-gray-500 italic">No contacts yet.</li>}
                  </ul>
                </div>
              </div>
            ))}
            {filtered.length===0 && <p className="text-gray-500 italic">No dealerships.</p>}
          </div>

          <div className="border rounded-2xl p-3 bg-white">
            <p className="text-sm font-medium mb-2">Merge dealerships (reassign all forms)</p>
            <div className="grid md:grid-cols-3 gap-2">
              <select className="px-3 py-2 border rounded-xl" value={mergeFrom} onChange={e=>setMergeFrom(e.target.value)}>
                <option value="">From…</option>
                {dealers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
              </select>
              <select className="px-3 py-2 border rounded-xl" value={mergeTo} onChange={e=>setMergeTo(e.target.value)}>
                <option value="">To…</option>
                {dealers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
              </select>
              <button className="px-3 py-2 rounded-xl border" onClick={()=>{ if(!mergeFrom||!mergeTo) return alert("Pick both"); mergeDealers(mergeFrom, mergeTo); }}>Merge</button>
            </div>
          </div>
        </div>
      );
    }

    function WalksPage({ dealers, forms, setForms }) {
      const [activeDealerId, setActiveDealerId] = useState(dealers.find(d=>!d.archived)?.id || "");
      useEffect(()=>{ if (!activeDealerId && dealers[0]) setActiveDealerId(dealers[0].id); }, [dealers]);

      const dealerForms = useMemo(()=>forms.filter(f=>f.dealershipId===activeDealerId), [forms, activeDealerId]);

      const newForm = () => {
        if (!activeDealerId) return alert("Select a dealership first");
        const historyUnits = dealerForms.flatMap(f => f.vehicles.filter(v => v.status === "hold" || v.notComplete));
        const suggested = dedupeUnits(historyUnits);
        const f = { id: uid(), dealershipId: activeDealerId, date: nowISO(), status: "draft",
          vehicles: suggested.map(u => ({ ...u, id: uid(), pictures: [], notes: (u.notes ? (u.notes + " | recalled") : "recalled"), status: "pending" })) };
        setForms([f, ...forms]);
      };

      const updateForm = (id, patch) => setForms(forms.map(f => f.id===id? {...f, ...patch}: f));
      const removeForm = (id) => { if (confirm("Delete this LotWalk?")) setForms(forms.filter(f=>f.id!==id)); };

      return (
        <div className="mx-auto max-w-5xl p-4 space-y-4">
          <div className="flex items-center gap-2">
            <select className="px-3 py-2 border rounded-xl" value={activeDealerId} onChange={e=>setActiveDealerId(e.target.value)}>
              {dealers.filter(d=>!d.archived).map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
              {dealers.length===0 && <option value="">No dealerships</option>}
            </select>
            <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={newForm}>New LotWalk</button>
          </div>

          <ul className="grid gap-4">
            {dealerForms.map(f => (
              <li key={f.id} className="border rounded-2xl p-4 space-y-3 bg-white shadow-sm">
                <FormCard form={f} onChange={updateForm} onDelete={removeForm} />
              </li>
            ))}
            {dealerForms.length===0 && <p className="text-gray-500 italic">No LotWalks yet for this dealership.</p>}
          </ul>
        </div>
      );
    }

    function SettingsPage() {
      return (
        <div className="mx-auto max-w-5xl p-4 space-y-3">
          <h2 className="text-lg font-semibold">Settings</h2>
          <p className="text-sm text-gray-600">Future features: theme toggle, export options, backups.</p>
        </div>
      );
    }

    function FormCard({ form, onChange, onDelete }) {
      const [tab, setTab] = useState("units");

      const addUnit = () => {
        const blank = { id: uid(), stock:"", year:"", make:"", model:"", color:"", vin:"",
          damagedPanels:[], price:null, notes:"", pictures:[], status:"pending", notComplete:false, _expanded:true };
        onChange(form.id, { vehicles: [blank, ...form.vehicles] });
      };
      const updateUnit = (vid, patch) => onChange(form.id, { vehicles: form.vehicles.map(v => v.id===vid ? {...v, ...patch} : v) });
      const removeUnit = (vid) => onChange(form.id, { vehicles: form.vehicles.filter(v => v.id!==vid) });

      const sendForApproval = () => onChange(form.id, { status:"sent_for_approval" });

      return (
        <div className="space-y-3">
          <div className="flex items-center gap-3">
            <span className="px-2 py-1 rounded-lg text-xs bg-gray-100">{new Date(form.date).toLocaleString()}</span>
            <StatusPill status={form.status} />
            <div className="flex-1" />
            <button className="px-3 py-2 rounded-xl border" onClick={()=>onDelete(form.id)}>Delete LotWalk</button>
          </div>

          <div className="flex gap-2">
            <Tab label="Units" active={tab==="units"} onClick={()=>setTab("units")} />
            <Tab label="Approval" active={tab==="approval"} onClick={()=>setTab("approval")} />
          </div>

          {tab === "units" && (
            <div className="space-y-4">
              <div className="flex items-center gap-2">
                <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={addUnit}>+Unit</button>
                <span className="text-sm text-gray-500">{form.vehicles.length} added</span>
                <div className="flex-1" />
                {form.status==="draft" && <button className="px-3 py-2 rounded-xl border" onClick={sendForApproval}>Send for Approval</button>}
              </div>

              <div className="space-y-3">
                {form.vehicles.map(v => (
                  <UnitCard key={v.id} unit={v} onChange={(patch)=>updateUnit(v.id, patch)} onRemove={()=>removeUnit(v.id)} />
                ))}
                {form.vehicles.length===0 && <p className="text-gray-500 italic">No units yet.</p>}
              </div>
            </div>
          )}

          {tab === "approval" && (
            <ApprovalPane form={form} onChange={onChange} />
          )}
        </div>
      );
    }

    function Tab({ label, active, onClick }) {
      return <button onClick={onClick} className={"px-3 py-2 rounded-xl border " + (active ? "bg-black text-white" : "bg-white")}>{label}</button>;
    }

    function StatusPill({ status }) {
      const map = {
        draft: "bg-gray-100 text-gray-800",
        sent_for_approval: "bg-yellow-100 text-yellow-800",
        approved: "bg-green-100 text-green-800",
        denied: "bg-red-100 text-red-800",
        hold: "bg-orange-100 text-orange-800",
      };
      return <span className={`px-2 py-1 rounded-lg text-xs ${map[status]}`}>{status.replaceAll("_"," ")}</span>;
    }

    const PANEL_OPTIONS = ["Hood","Roof","Trunk","LF Fender","RF Fender","LR Door","RR Door","LR Qtr","RR Qtr","L Rocker","R Rocker","L A-Pillar","R A-Pillar","Belt Moldings","Other"];

    function UnitCard({ unit, onChange, onRemove }) {
      const fileInputRef = useRef(null);
      const addPhotos = async (files) => {
        const arr = await Promise.all(Array.from(files).map(file => fileToDataURL(file)));
        onChange({ pictures: [...unit.pictures, ...arr] });
      };
      const toggleExpanded = () => onChange({ _expanded: !unit._expanded });

      // Top Complete button (duplicate at bottom for UX)
      const completeUnit = () => onChange({ _expanded:false });

      return (
        <div className="border rounded-2xl p-3">
          <div className="flex items-center gap-2">
            <span className="px-2 py-1 rounded-lg text-xs bg-gray-100">{unit.status}</span>
            <div className="flex-1" />
            <button className="px-3 py-1.5 rounded-xl border" onClick={toggleExpanded}>{unit._expanded ? "Collapse" : "Open"}</button>
            <button className="px-3 py-1.5 rounded-xl border" onClick={onRemove}>Remove</button>
          </div>

          {!unit._expanded ? (
            <div className="mt-2 flex items-center gap-3 text-sm">
              <span className="font-medium">{unit.stock || "—"}</span>
              <span>• {unit.model || "Model?"}</span>
              <span>• {unit.color || "Color?"}</span>
            </div>
          ) : (
            <div className="space-y-3 mt-3">
              <div className="flex items-center justify-end">
                <button className="px-3 py-1.5 rounded-xl border" onClick={completeUnit}>Complete</button>
              </div>

              <div className="grid md:grid-cols-3 gap-3">
                <label className="text-sm">Stock
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={unit.stock} onChange={e=>onChange({stock:e.target.value})} />
                </label>
                <label className="text-sm">Year
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" inputMode="numeric" value={unit.year} onChange={e=>onChange({year:e.target.value})} />
                </label>
                <label className="text-sm">Make
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={unit.make} onChange={e=>onChange({make:e.target.value})} />
                </label>
                <label className="text-sm">Model
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={unit.model} onChange={e=>onChange({model:e.target.value})} />
                </label>
                <label className="text-sm">Color
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={unit.color} onChange={e=>onChange({color:e.target.value})} />
                </label>
                <label className="text-sm">VIN
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={unit.vin} onChange={e=>onChange({vin:e.target.value})} />
                </label>
                <label className="text-sm">Price ($)
                  <input className="mt-1 w-full px-3 py-2 border rounded-xl" inputMode="decimal" value={unit.price ?? ""} onChange={e=>onChange({price:e.target.value?Number(e.target.value):null})} />
                </label>
                <div className="md:col-span-2">
                  <label className="text-sm">Notes
                    <textarea className="mt-1 w-full px-3 py-2 border rounded-xl" value={unit.notes} onChange={e=>onChange({notes:e.target.value})} />
                  </label>
                </div>
              </div>

              <div>
                <p className="text-sm mb-1">Damaged Panels</p>
                <div className="flex flex-wrap gap-2">
                  {PANEL_OPTIONS.map(p => (
                    <label key={p} className={"px-2 py-1.5 rounded-xl border text-sm select-none " + (unit.damagedPanels.includes(p) ? "bg-black text-white" : "bg-white") }>
                      <input type="checkbox" className="hidden" checked={unit.damagedPanels.includes(p)} onChange={e=>{
                        const s = new Set(unit.damagedPanels); if (e.target.checked) s.add(p); else s.delete(p);
                        onChange({ damagedPanels: Array.from(s) });
                      }} />
                      {p}
                    </label>
                  ))}
                </div>
              </div>

              <div className="grid gap-2">
                <div className="flex items-center gap-2">
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>fileInputRef.current?.click()}>Add Pictures</button>
                  <input ref={fileInputRef} type="file" accept="image/*" multiple capture="environment" className="hidden" onChange={e=>e.target.files && addPhotos(e.target.files)} />
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" className="w-4 h-4" checked={unit.notComplete} onChange={e=>onChange({notComplete:e.target.checked})} />
                    Not complete
                  </label>
                </div>
                <div className="flex gap-2 overflow-x-auto">
                  {unit.pictures.map((src,i)=>(
                    <div key={i} className="relative">
                      <img src={src} className="h-24 w-24 object-cover rounded-xl border"/>
                      <button className="absolute -top-2 -right-2 bg-white border rounded-full w-6 h-6" onClick={()=>onChange({pictures: unit.pictures.filter((_,idx)=>idx!==i)})}>×</button>
                    </div>
                  ))}
                  {unit.pictures.length===0 && <p className="text-sm text-gray-500">No pictures yet.</p>}
                </div>
              </div>

              <div className="flex flex-wrap gap-2">
                <UnitStatusSelect value={unit.status} onChange={val=>onChange({status:val})} />
              </div>

              <div className="flex items-center justify-end">
                <button className="px-3 py-1.5 rounded-xl border" onClick={completeUnit}>Complete</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function UnitStatusSelect({ value, onChange }) {
      const statuses = ["pending","approved","denied","hold","Repaired","NoCharge","NotRepaired"];
      return (
        <label className="text-sm flex items-center gap-2">Unit status
          <select className="px-3 py-2 border rounded-xl" value={value} onChange={e=>onChange(e.target.value)}>
            {statuses.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </label>
      );
    }

    function ApprovalPane({ form, onChange }) {
      const finalize = (decision) => onChange(form.id, { status: decision==="approve"?"approved":decision==="deny"?"denied":"hold", approverDecision: decision });
      const saveSig = (sig) => onChange(form.id, { approverSignature: sig });
      return (
        <div className="space-y-4">
          <p className="text-sm text-gray-600">Approvals can be on-device. Data stays local.</p>
          <div className="flex flex-wrap gap-2">
            <button disabled={form.status==="approved"} className="px-3 py-2 rounded-xl border" onClick={()=>finalize("approve")}>Approve</button>
            <button disabled={form.status==="denied"} className="px-3 py-2 rounded-xl border" onClick={()=>finalize("deny")}>Deny</button>
            <button disabled={form.status==="hold"} className="px-3 py-2 rounded-xl border" onClick={()=>finalize("hold")}>Hold</button>
          </div>
          <div className="grid gap-3">
            <label className="text-sm">Approver name
              <input className="mt-1 w-full px-3 py-2 border rounded-xl" value={form.approverName||""} onChange={e=>onChange(form.id,{approverName:e.target.value})} />
            </label>
            <label className="text-sm">Approver notes
              <textarea className="mt-1 w-full px-3 py-2 border rounded-xl" value={form.approverNotes||""} onChange={e=>onChange(form.id,{approverNotes:e.target.value})} />
            </label>
            <div>
              <p className="text-sm mb-2">Signature</p>
              <SignaturePad value={form.approverSignature||null} onChange={saveSig} />
            </div>
          </div>
        </div>
      );
    }

    function SignaturePad({ value, onChange }) {
      const canvasRef = useRef(null);
      const drawing = useRef(false);
      const last = useRef({x:0,y:0});
      useEffect(()=>{
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d"); ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="black";
        const resize = () => {
          const rect = canvas.getBoundingClientRect();
          canvas.width = rect.width; canvas.height = 160;
          ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
          if (value) { const img = new Image(); img.onload=()=>ctx.drawImage(img,0,0); img.src=value; }
        };
        resize(); window.addEventListener("resize", resize);
        return ()=>window.removeEventListener("resize", resize);
      }, []);
      const getPos = (e)=>{
        const r = canvasRef.current.getBoundingClientRect();
        const t = e.touches?.[0]; const x = (t?t.clientX:e.clientX)-r.left; const y=(t?t.clientY:e.clientY)-r.top; return {x,y};
      };
      const start = (e)=>{ drawing.current=true; last.current=getPos(e); };
      const move = (e)=>{ if(!drawing.current) return; const ctx = canvasRef.current.getContext("2d"); const p = getPos(e); ctx.beginPath(); ctx.moveTo(last.current.x,last.current.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last.current=p; };
      const end = ()=>{ drawing.current=false; const data=canvasRef.current.toDataURL(); onChange?.(data); };
      const clear = ()=>{ const c=canvasRef.current; const ctx=c.getContext("2d"); ctx.fillStyle="white"; ctx.fillRect(0,0,c.width,c.height); onChange?.(null); };
      return (
        <div className="space-y-2">
          <canvas ref={canvasRef} className="w-full h-40 border rounded-xl bg-white touch-none"
            onMouseDown={start} onMouseMove={move} onMouseUp={end} onMouseLeave={end}
            onTouchStart={start} onTouchMove={move} onTouchEnd={end} />
          <div className="flex gap-2">
            <button type="button" className="px-3 py-1.5 rounded-lg border" onClick={clear}>Clear</button>
            <span className="text-sm text-gray-500 self-center">Sign above</span>
          </div>
        </div>
      );
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader(); reader.onload = () => resolve(reader.result);
        reader.onerror = reject; reader.readAsDataURL(file);
      });
    }
    function dedupeUnits(units) {
      const map = new Map();
      for (const u of units) { const key = (u.vin || u.stock || u.id || "").trim(); if (!map.has(key)) map.set(key, u); }
      return Array.from(map.values());
    }

    function App() {
      const [dealers0, setDealers] = useLocalStorage(LS_KEYS.dealers, []);
      const [forms0, setForms0] = useLocalStorage(LS_KEYS.forms, []);
      const mig = migrate(dealers0, forms0);
      const [dealers, _setDealers] = useState(mig.dealers);
      const [forms, _setForms] = useState(mig.forms);
      const [route, setRoute] = useState("walks");

      // expose setters so merge can update forms
      useEffect(()=>{ window._setForms = (x)=>{ _setForms(x); setForms0(x); }; }, []);

      useEffect(()=>{ _setDealers(dealers); setDealers(dealers); }, [dealers]);
      useEffect(()=>{ _setForms(forms); setForms0(forms); }, [forms]);

      return (
        <div>
          <Nav route={route} setRoute={setRoute} />
          {route==="walks" && <WalksPage dealers={dealers} forms={forms} setForms={_setForms} />}
          {route==="dealers" && <DealerManagePage dealers={dealers} setDealers={_setDealers} forms={forms} />}
          {route==="settings" && <SettingsPage />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
